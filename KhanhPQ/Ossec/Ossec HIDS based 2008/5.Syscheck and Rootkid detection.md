# System Integrity Check (Kiểm tra tính toàn vẹn) and Rootkit Detection (Phát hiện Rootkit)
Chủ yếu nói về cơ chế kiểm tra và phát hiện của OSSEC

OSSEC HIDS = Ossec Server
# 1. Understanding System  Integrity Check (syscheck)
- Kiểm tra bằng cách : **so sánh checksum (MD5/SHA1)** của tệp ở mỗi đợt kiểm tra 
- Ossec HIDS (Server) sẽ tìm kiếm sự thay đổi checksum của các file trên hệ thống / các Window registry.
- Ossec Agent sẽ quét hệ thống sau vài giờ hoặc sau thời gian chỉ định. Sau đó gửi tổng hợp checksum tới Server.
- Server lưu các checksum và tìm kiếm sự thay đổi bằng cách so sánh checksum mới nhận được với giá trị cũ
- Cảnh báo sẽ được gửi nếu có bất cứ thay đổi gì

**NOTE :**
- Ossec HIDS thì bản chất nó cũng chỉ có thể thông báo cho ta trong hoặc sau khi cuộc tấn công đã xảy ra
- Do vậy, Server cài đặt Ossec HIDS cần phải đảm bảo an toàn nhất trong network <=> OS bảo vệ Ossec, Ossec bảo vệ network ==> Ossec sử dụng Linux làm Server
- Bất cứ điều gì mở ra quyền truy cập đều có thể trở thành điểm khai thác của Attacker, Làm ảnh hưởng đến Ossec Server --> Cần bảo vệ Ossec Server khỏi cả các tấn công bên trong mạng, từ các server "bạn"

**1 số nguyên tắc cần nhớ để bảo vệ Ossec server :**
- Không cài chung nhiều service trên Server cài Ossec server
- Không cài đặt các software không cần thiết
- Tất cả các port không phải của Ossec HIDS đều phải block
- Nếu sử dụng WUI thì phải chắc chắn nó chỉ có thể được truy cập từ các host được bảo mật
- server Ossec HIDS phải nằm phía sau. không public
- Tuân thủ các quy tắc an toàn trên hệ thống đã được quy định từ trước

--> Giúp giảm thiểu truy cập trái phép và khiến việc cài đặt Rootkit,Malware trở nên khó khăn hơn.

## Bắt đầu
- Kiểm tra tính toàn vẹn giúp đảm bảo rằng malware không thể thay đổi các file quan trọng
- Malware khi được cài đặt thường để lại dấu vết/ chứng cứ số (thay đổi file --> thay đổi checksum)


Cơ chế kiểm tra tính toàn vẹn trong Ossec HIDS có tên là **syscheck**
- Ta cần quyết định rõ những gì cần giám sát.
- mặc định sẽ check: 
    Trên Windows
    ```
    C:\Windows\System32
    ```
```xml
<syscheck>
  <directories check_all=“yes”>%WINDIR%/system32</directories>
</syscheck>
```
    Trên Linux
    ```
    /etc
    /usr/bin
    /usr/sbin
    /bin
    /sbin
    /boot
    ```
```xml
  <syscheck>
    <!-- Frequency that syscheck is executed - default to every 22 hours -->
    <frequency>79200</frequency>

    <!-- Directories to check  (perform all possible verifications) -->
    <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/bin,/sbin,/boot</directories>

    <!-- Files/directories to ignore -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/mnttab</ignore>
    <ignore>/etc/hosts.deny</ignore>
    <ignore>/etc/mail/statistics</ignore>
    <ignore>/etc/random-seed</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/httpd/logs</ignore>
    <ignore>/etc/utmpx</ignore>
    <ignore>/etc/wtmpx</ignore>
    <ignore>/etc/cups/certs</ignore>
    <ignore>/etc/dumpdates</ignore>
    <ignore>/etc/svc/volatile</ignore>

  </syscheck>
```
- `<frequency></frequency>` : Chỉ định tần xuất kiểm tra . Tính theo giây
- `<directories></directories>` : cho phép bao gồm một số tham số cho việc giám sát

<img src="..\img\Screenshot_81.png">
Thường sử dụng check_all để check hết các yếu tố

- Sử dụng `<ignore></ignore>` : để chỉ định các file ta sẽ bỏ qua không kiểm tra. Vì có 1 số file thay đổi liên tục và không mang tính security

    ```
    Nếu dùng <ignore> trên Agent thì sẽ chỉ bỏ qua trên Agent.
    Tất cả những gì được ignore trên Server thì cũng được ignore trên Agent

    ```


# 1.1 Điều chỉnh syscheck
Mặc định thì syscheck vẫn sẽ hoạt động nhưng nó sẽ tạo cảnh báo hỗn loạn. Ta cần dành thời gian chỉnh sửa.

## 1.1.1 Làm việc với syscheck Rule
tất cả các cảnh báo syscheck đều nằm trong group syscheck. 

Bất cứ local rule nào ta tạo để cảnh báo việc thay đổi tệp, thư mục hay registry key đều cần thêm `<if_ group>syscheck</if_ group>` --> làm rule này phụ thuộc vào group syscheck

```xml
<rule id=“100501” level=“7”>
  <if_group>syscheck</if_group>
</rule>
```

Tin nhắn cảnh báo sẽ có dạng như sau:

<img src="..\img\Screenshot_82.png">
Chứa 1 số thông tin như:
- tên file đã bị sửa đổi
- ID rule , level rule
- md5 cũ và mới
- sha1sum cũ và mới

## 1.1.2 Bỏ qua 1 Directory

Ngoài việc sử dụng `<ignore>` thì ta cũng có thể viết rule cho việc này. File sẽ vẫn được quét, tuy nhiên sẽ không gửi cảnh báo do level ta đặt dưới ngưỡng tạo cảnh báo
```xml
<rule id=“100611” level=“0”>
  <if_group>syscheck</if_group>
  <match>for: ‘/etc/www/logs</match>
  <description>Ignoring /etc/www/logs change.</description>
</rule>
```

## 1.1.3 Tăng mức cảnh báo cho các file quan trọng

```xml
<rule id=“100614” level=“10”>
  <if_group>syscheck</if_group>
  <match>for: ‘C:\Docs</match>
  <regex>for: ‘\S+.doc’</regex>
  <hostname>central-2k|main-db</hostname>
  <description>Important docs changed.</description>
</rule>
```

Kiểm tra nếu các file doc trong ổ **C:\Docs** trên 2 Agent là central-2k, main-db mà bị sửa đổi thì gửi cảnh báo (level cao --> gửi mail) kèm thêm description

## 1.1.4 Tăng mức nghiêm trọng (Severity) cho những thay đổi vào ngày cuối tuần 

```xml
<rule id=“100615” level=“12”>
  <if_sid>100614</if_sid>
  <weekday>weekend</weekday>
  <description>Important docs changed during the weekend.</description>
</rule>
```
- Nâng mức level lên
- Gọi ngược đến rule 100614 kiểm tra các file quan trọng
- Thêm `<weekday>weekend</weekday>` : chỉ định kiểm tra cuối tuần (T7,CN)
- Thêm desciption mới

## 1.1.5 Cấu hình việc Syscheck Monitoring

```xml
<syscheck>
  <frequency>86400</frequency>
  <directories check_all=“yes”>/opt/important_data_,/var/www/htdocs</directories>
</syscheck>
```

Viết rule nâng mức cảnh báo--> local_rules.xml
```xml
<rule id=“100617” level=“10”>
  <if_group>syscheck</if_group>
  <match>for: ‘/var/www/htdocs|for: ‘/opt/important_data/conf</match>
  <description>High severity alerts for syscheck changes.</description>
</rule>
```
### 1.1.6 Realtime Monitoring
Ossec cung cấp 1 option hữu ích là kiểm tra tính toàn vẹn Realtime.
- Chỉ có thể cấu hình cho directory chứ không cấu hình cho từng file riêng lẻ
- Sau khi cấu hình cần 1 khoảng thời gian để scan lại hệ thống và đưa các directory được chỉ định vào realtime queue

```xml
<syscheck>
  <directories realtime="yes" check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
  <directories check_all="yes">/bin,/sbin</directories>
</syscheck>
```
**LƯU Ý** : 
- có thể cấu hình trên agent- để đảm bảo chi tiết, đúng directory cần realtime monitor

- Hoặc trên server để đảm bảo realtime với cả server và agent

Ví dụ trên Agent
```xml 
  <syscheck>
    <!-- Frequency that syscheck is executed default every 6 hours -->
    <frequency>21600</frequency>
    <scan_on_start>yes</scan_on_start>
    <skip_nfs>yes</skip_nfs>
    <alert_new_files>yes</alert_new_files>
    <auto_ignore>no</auto_ignore>

    <!-- Directories to check  (perform all possible verifications) -->
    <directories realtime="yes" check_all="yes" report_changes="yes">/boot</directories>
    <directories realtime="yes" check_all="yes" report_changes="yes">/etc</directories>
    <directories realtime="yes" check_all="yes" report_changes="yes">/usr/local/etc</directories>
    <directories realtime="yes" check_all="yes">/bin</directories>
    <directories realtime="yes" check_all="yes">/usr/bin</directories>
    <directories realtime="yes" check_all="yes">/sbin</directories>
    <directories realtime="yes" check_all="yes">/usr/sbin</directories>
    <directories realtime="yes" check_all="yes">/lib,/lib64,/usr/lib,/usr/lib64</directories>
    <directories realtime="yes" check_all="yes">/usr/local/bin</directories>
    <directories realtime="yes" check_all="yes">/usr/local/sbin</directories>
    <directories realtime="yes" check_all="yes">/usr/local/lib</directories>
    <directories realtime="yes" check_all="yes">/usr/local/lib64</directories>

    <!-- Files/directories to ignore -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/hosts.deny</ignore>
    <ignore>/etc/mail/statistics</ignore>
    <ignore>/etc/random-seed</ignore>
    <ignore>/etc/random.seed</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/httpd/logs</ignore>
    <ignore>/etc/utmpx</ignore>
    <ignore>/etc/wtmpx</ignore>
    <ignore>/etc/cups/certs</ignore>
    <ignore>/etc/dumpdates</ignore>
    <ignore>/etc/svc/volatile</ignore>


    <!-- Check the file, but never compute the diff -->
    <nodiff>/etc/ssl/private.key</nodiff>
  </syscheck>
```
# 2. Phát hiện Rootkis và Thực thi/Giám sát các Policy

- Có thể phát hiện rootkits cấp application dựa trên các signature.
- Có thể phát hiện rootkits cấp kernel dựa trên việc so sánh các system call
- Việc kiểm tra dựa trên những sự bất thường cũng được thực hiện để đảm bảo hệ thống hoạt động bình thường
- Việc giám sát/thực thi các Policy giúp đảm bảo hệ thống tuân thủ các chính sách được định trước về việc config,cài đặt ứng dụng, sử dụng ứng dụng được phê duyệt,...

Ví dụ: Ta chỉ cho phép cài đặt , sử dụng Chrome nhưng có người lại cài đặt FireFox --> như vậy ng đó đã vi phạm chính sách.

<img src="..\img\Screenshot_83.png">
<img src="..\img\Screenshot_84.png">

```xml
  <rootcheck>
    <frequency>86400</frequency>
    <rootkit_files>/var/ossec//etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec//etc/shared/rootkit_trojans.txt</rootkit_trojans>
    <system_audit>/var/ossec//etc/shared/system_audit_rcl.txt</system_audit>
    <system_audit>/var/ossec//etc/shared/cis_rhel_linux_rcl.txt</system_audit>
    <system_audit>/var/ossec//etc/shared/cis_rhel5_linux_rcl.txt</system_audit>
  </rootcheck>
```
Ngoại trừ `<frequency>` ra thì nên giữ nguyên config ban đầu. Bởi kia là đường dẫn đến các file chứa signature của rootkits.
